<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <title>YouVideo</title>
</head>
<body>
    <nav class="navbar2">
        <div class="nav-left">
            <a class="logo" href="/"><h1>YouVideo</h1></a>
        </div>
        <div class="nav-right">
            <div class="profile-nav" id="profileNav"></div>
            <button id="loginButton2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                </svg>
                Sign in
            </button>
        </div>
    </nav>
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="dropdown-item" id="signIn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-right" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0z"/>
                <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
            </svg>
            <span>Sign in</span>
        </div>
        <div class="dropdown-item" id="yourChannel">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
            </svg>
            <span>Your channel</span>
        </div>
        <div class="dropdown-item" id="signOut">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
            </svg>
            <span>Sign out</span>
        </div>
    </div>
    <section class="signin" id="loginForm" style="display: none;">
        <div class="content">
            <span class="close" id="closeLoginForm">&times;</span>
            <h2>Login</h2>
            <form class="form" action="/login" method="POST">
                <div class="inputBox">
                    <i>Username</i>
                    <input type="text" name="userName" id="userName" placeholder="Username" required autocomplete="username">
                </div>
                <div class="inputBox">
                    <i>Password</i>
                    <input type="password" name="userPassword" id="userPassword" placeholder="Password" required autocomplete="current-password">
                </div>
                <input id="loginButton" type="submit" value="Login">
            </form>
            <button id="registerButton">Register</button>
        </div>
    </section>
    <div class="video-container">
        <div id="videoPlaceholder" style="width: 1280px; height: 720px; background-color: gray; display: none;"></div>
        <video id="videoPlayer" controls style="display: none;" poster=""></video>
        
        <!-- Video Information Container -->
        <div class="video-info-container">
            <h2 id="videoName" class="video-name"></h2>
            <div class="author-info">
                <img id="authorProfilePic" class="author-profile-pic" alt="Author Profile" onclick="window.location.href='/profile.html?user=' + document.getElementById('authorName').textContent;">
                 <div class="text-info">
                    <a id="authorName" class="video-author" onclick="window.location.href='/profile.html?user=' + this.textContent;"></a>
                    <p id="uploadDate" class="video-date"></p>
                </div>
                <div class="video-interactions">
                    <div class="interaction-container">
                        <button id="likeBtn" class="interaction-btn">
                            <svg id="likeIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-up">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h3a4 4 0 0 0 4 -4v-1a2 2 0 0 1 4 0v5h3a2 2 0 0 1 2 2l-1 5a2 3 0 0 1 -2 2h-7a3 3 0 0 1 -3 -3" />
                            </svg>
                            <svg id="likeIconActive"  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"  class="icon icon-tabler icons-tabler-filled icon-tabler-thumb-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 3a3 3 0 0 1 2.995 2.824l.005 .176v4h2a3 3 0 0 1 2.98 2.65l.015 .174l.005 .176l-.02 .196l-1.006 5.032c-.381 1.626 -1.502 2.796 -2.81 2.78l-.164 -.008h-8a1 1 0 0 1 -.993 -.883l-.007 -.117l.001 -9.536a1 1 0 0 1 .5 -.865a2.998 2.998 0 0 0 1.492 -2.397l.007 -.202v-1a3 3 0 0 1 3 -3z" /><path d="M5 10a1 1 0 0 1 .993 .883l.007 .117v9a1 1 0 0 1 -.883 .993l-.117 .007h-1a2 2 0 0 1 -1.995 -1.85l-.005 -.15v-7a2 2 0 0 1 1.85 -1.995l.15 -.005h1z" /></svg>
                            <span id="likeCount">0</span>
                        </button>
                        <button id="dislikeBtn" class="interaction-btn">
                            <svg id="dislikeIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-down">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <path d="M7 13v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1v7a1 1 0 0 0 1 1h3a4 4 0 0 1 4 4v1a2 2 0 0 0 4 0v-5h3a2 2 0 0 0 2 -2l-1 -5a2 3 0 0 0 -2 -2h-7a3 3 0 0 0 -3 3" />
                            </svg>
                            <svg id="dislikeIconActive" xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"  class="icon icon-tabler icons-tabler-filled icon-tabler-thumb-down"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 21.008a3 3 0 0 0 2.995 -2.823l.005 -.177v-4h2a3 3 0 0 0 2.98 -2.65l.015 -.173l.005 -.177l-.02 -.196l-1.006 -5.032c-.381 -1.625 -1.502 -2.796 -2.81 -2.78l-.164 .008h-8a1 1 0 0 0 -.993 .884l-.007 .116l.001 9.536a1 1 0 0 0 .5 .866a2.998 2.998 0 0 1 1.492 2.396l.007 .202v1a3 3 0 0 0 3 3z" /><path d="M5 14.008a1 1 0 0 0 .993 -.883l.007 -.117v-9a1 1 0 0 0 -.883 -.993l-.117 -.007h-1a2 2 0 0 0 -1.995 1.852l-.005 .15v7a2 2 0 0 0 1.85 1.994l.15 .005h1z" /></svg>
                            <span id="dislikeCount">0</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="video-stats">
                <span id="viewCount">0 views</span>
                <span id="videoDate" class="video-date"></span>
            </div>
        </div>
        <div class="comments-section">
            <h3>Comments</h3>
            <form id="commentForm">
                <textarea id="commentText" placeholder="Add a comment..." required></textarea>
                <button type="submit" id="postCommentBtn">Post Comment</button>
            </form>
            <div id="commentsContainer"></div>
        </div>
    </div>

    <script>

        const textarea = document.getElementById('commentText');

        textarea.addEventListener('input', autoResize, false);

        function autoResize() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        }
        function getVideoId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        async function loadVideoInteractions() {
            try {
                const videoId = new URLSearchParams(window.location.search).get('id');
                const response = await fetch(`/api/video/interactions/${videoId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch video interactions');
                }
                const data = await response.json();
                
                document.getElementById('likeCount').textContent = data.likes;
                document.getElementById('dislikeCount').textContent = data.dislikes;

                if (data.userInteraction === 'LIKE') {
                    document.getElementById('likeBtn').classList.add('active');
                } else if (data.userInteraction === 'DISLIKE') {
                    document.getElementById('dislikeBtn').classList.add('active');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('likeBtn').addEventListener('click', async () => {
            try {
                const videoId = new URLSearchParams(window.location.search).get('id');
                const likeBtn = document.getElementById('likeBtn');
                const isActive = likeBtn.classList.contains('active');
                const interactionType = isActive ? 'REMOVE' : 'LIKE';

                const response = await fetch('/api/video/interact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoId: videoId,
                        interactionType: interactionType
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('likeCount').textContent = data.likes;
                    document.getElementById('dislikeCount').textContent = data.dislikes;
                    if (interactionType === 'REMOVE') {
                        likeBtn.classList.remove('active');
                    } else {
                        likeBtn.classList.add('active');
                        document.getElementById('dislikeBtn').classList.remove('active');
                    }
                } else if (response.status === 401) {
                    alert('Please log in to like videos');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        document.getElementById('dislikeBtn').addEventListener('click', async () => {
            try {
                const videoId = new URLSearchParams(window.location.search).get('id');
                const dislikeBtn = document.getElementById('dislikeBtn');
                const isActive = dislikeBtn.classList.contains('active');
                const interactionType = isActive ? 'REMOVE' : 'DISLIKE';

                const response = await fetch('/api/video/interact', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoId: videoId,
                        interactionType: interactionType
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('likeCount').textContent = data.likes;
                    document.getElementById('dislikeCount').textContent = data.dislikes;
                    if (interactionType === 'REMOVE') {
                        dislikeBtn.classList.remove('active');
                    } else {
                        dislikeBtn.classList.add('active');
                        document.getElementById('likeBtn').classList.remove('active');
                    }
                } else if (response.status === 401) {
                    alert('Please log in to dislike videos');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        async function fetchComments() {
            const videoId = getVideoId();
            if (!videoId) {
                console.error('No video ID found in URL');
                return;
            }

            try {
                const response = await fetch(`/api/comments/${videoId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const comments = await response.json();
                const commentsContainer = document.getElementById('commentsContainer');
                commentsContainer.innerHTML = '';
                comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('comment');
                    commentElement.innerHTML = `
                        <img src="/profile-picture/${comment.user_name}" 
                            onerror="this.src='/default-profile.png'" 
                            class="comment-profile-pic"
                            alt="${comment.user_name}'s profile picture">
                        <div class="comment-content">
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                                <p style="font-size: 1.1rem; margin: 0;"><strong>${comment.user_name}</strong></p>
                                <p style="opacity: 0.5; margin: 0; font-size: 0.9rem;">${comment.comment_date}</p>
                            </div>
                            <p style="margin: 0;">${comment.comment_text}</p>
                        </div>
                    `;
                    commentsContainer.appendChild(commentElement);
                });
            } catch (error) {
                console.error('Error fetching comments:', error.message);
                const commentsContainer = document.getElementById('commentsContainer');
                commentsContainer.innerHTML = '<p>Failed to load comments. Please try again later.</p>';
            }
        }

        document.getElementById('commentForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent the default form submission

            const videoId = getVideoId();
            const commentText = document.getElementById('commentText').value.trim(); // Trim whitespace

            if (!commentText) {
                console.error('Comment text is empty');
                return;
            }

            try {
                const response = await fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoId: videoId,
                        commentText: commentText // Ensure the key matches the server-side expectation
                    })
                });

                if (response.ok) {
                    const message = await response.text(); // Use response.text() to handle plain text
                    console.log('Comment posted successfully:', message);
                    // Clear the comment input
                    document.getElementById('commentText').value = '';
                    // Reload comments or update the comments section
                    await fetchComments(videoId);
                } else {
                    console.error('Failed to post comment');
                }
            } catch (error) {
                console.error('Error posting comment:', error);
            }
        });

        async function recordView() {
            const videoId = new URLSearchParams(window.location.search).get('id');
            try {
                const response = await fetch(`/api/video/record-view/${videoId}`, {
                    method: 'POST'
                });
                if (response.status === 401) {
                    console.log('User not logged in, view not recorded');
                    return;
                }
                const data = await response.json();
                document.getElementById('viewCount').textContent = 
                    `${data.views} ${data.views === 1 ? 'view' : 'views'}`;
            } catch (error) {
                console.error('Error recording view:', error);
            }
        }

        async function checkLoginStatus() {
            try {
                const response = await fetch('/check-login');
                const data = await response.json();
                const profileNav = document.getElementById('profileNav');
                const dropdownMenu = document.getElementById('dropdownMenu');
                
                if (data.loggedIn) {
                    profileNav.innerHTML = `
                <img 
                    src="/profile-picture/${data.user.userName}?${new Date().getTime()}" 
                    alt="Profile" 
                    onerror="this.src='/default-profile.png'"
                    class="profile-picture"
                />
            `;
            profileNav.style.display = 'block';
            loginButton2.style.display = 'none';

            dropdownMenu.innerHTML = `
                <div class="dropdown-item" id="yourChannel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                    </svg>
                    <span>Your channel</span>
                </div>
                <div class="dropdown-item" id="signOut">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
                        <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                    </svg>
                    <span>Sign out</span>
                </div>
            `;

                    dropdownMenu.innerHTML = `
                        <div class="dropdown-item" id="yourChannel">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                            </svg>
                            <span>Your channel</span>
                        </div>
                        <div class="dropdown-item" id="signOut">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
                                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                            </svg>
                            <span>Sign out</span>
                        </div>
                    `;
                } else {
                    profileNav.style.display = 'none';
                    loginButton2.style.display = 'flex';

                    dropdownMenu.innerHTML = `
                        <div class="dropdown-item" id="signIn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-right" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0z"/>
                                <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                            </svg>
                            <span>Sign in</span>
                        </div>
                    `;

                    dropdownMenu.innerHTML = `
                        <div class="dropdown-item" id="signIn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-right" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0z"/>
                                <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                            </svg>
                            <span>Sign in</span>
                        </div>
                    `;

                }
                
                const oldProfileNav = document.getElementById('profileNav');
                const newProfileNav = oldProfileNav.cloneNode(true);
                oldProfileNav.parentNode.replaceChild(newProfileNav, oldProfileNav);
                
                newProfileNav.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Profile clicked');
                    dropdownMenu.classList.toggle('show');
                });

                document.addEventListener('click', function(e) {
                    if (!dropdownMenu.contains(e.target) && !newProfileNav.contains(e.target)) {
                        dropdownMenu.classList.remove('show');
                    }
                });

                attachDropdownListeners();
            } catch (error) {
                console.error('Error checking login status:', error);
            }
        }

        function attachDropdownListeners() {
    const yourChannel = document.getElementById('yourChannel');
    const signOut = document.getElementById('signOut');
    const signIn = document.getElementById('signIn');

    document.getElementById('loginButton2').addEventListener('click', () => {
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.style.display = 'flex';
        requestAnimationFrame(() => {
            loginForm.classList.add('active');
        });
    }
});

document.getElementById('closeLoginForm').addEventListener('click', function() {
    const loginForm = document.getElementById('loginForm');
    loginForm.classList.remove('active');
    setTimeout(() => {
        loginForm.style.display = 'none';
    }, 200);
});

async function handleSignOut() {
        try {
            const response = await fetch('/logout', {
                method: 'POST'
            });
            if (response.ok) {
                window.location.reload();
            } else {
                console.error('Error logging out');
            }
        } catch (error) {
            console.error('Error logging out:', error);
        }
    }

    document.getElementById('signOut').addEventListener('click', handleSignOut);

document.getElementById('loginForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const userName = document.getElementById('userName').value;
    const userPassword = document.getElementById('userPassword').value;

    try {
        const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userName, userPassword })
                });

                if (response.ok) {
                    // Reload the page after successful login
                    window.location.reload();
                } else {
                    const error = await response.json();
                    alert(error.error);
                }
    } catch (error) {
        console.error('Error during login:', error);
    }
});

    if (yourChannel) {
        yourChannel.addEventListener('click', () => {
            window.location.href = '/profile.html';
        });
    }

    if (signOut) {
        signOut.addEventListener('click', async () => {
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error logging out:', error);
            }
        });
    }

    if (signIn) {
        signIn.addEventListener('click', () => {
            window.location.href = '/';
        });
    }
}

        function handleOutsideClick(e) {
            const profileNav = document.getElementById('profileNav');
            const dropdownMenu = document.getElementById('dropdownMenu');
            if (!dropdownMenu.contains(e.target) && !profileNav.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        }

        async function fetchVideoBlob(videoId) {
            try {
                const videoPlayer = document.getElementById('videoPlayer');
                const placeholder = document.getElementById('videoPlaceholder');
                
                // Show placeholder initially
                placeholder.style.display = 'block';
                videoPlayer.style.display = 'none';
                
                // Set video source
                videoPlayer.src = `/video/blob/${videoId}`;
                
                // Add event listeners
                videoPlayer.addEventListener('canplay', () => {
                    placeholder.style.display = 'none';
                    videoPlayer.style.display = 'block';
                });

                videoPlayer.addEventListener('waiting', () => {
                    placeholder.style.display = 'block';
                    videoPlayer.style.display = 'none';
                });

                videoPlayer.addEventListener('error', (e) => {
                    console.error('Video loading error:', e);
                    placeholder.style.display = 'block';
                    videoPlayer.style.display = 'none';
                });

                return videoPlayer.src;
            } catch (error) {
                console.error('Error fetching video blob:', error);
                document.getElementById('videoPlaceholder').style.display = 'block';
                throw error;
            }
        }

        async function fetchVideoDetails(videoId) {
            try {
                const videoResponse = await fetch('/videos');
                const videos = await videoResponse.json();
                const videoDetails = videos.find(video => video.id === parseInt(videoId));
                
                if (!videoDetails) {
                    throw new Error('Video not found');
                }

                return {
                    video_name: videoDetails.video_name,
                    author: videoDetails.author,
                    video_date: videoDetails.upload_date
                };
            } catch (error) {
                console.error('Error fetching video details:', error);
            }
        }

        async function loadVideo() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id');
            
            if (!videoId || isNaN(parseInt(videoId, 10))) {
                console.error('Invalid or missing Video ID in URL');
                return;
            }

            const videoPlayer = document.getElementById('videoPlayer');
            const placeholder = document.getElementById('videoPlaceholder');
            
            // Configure video player
            videoPlayer.controls = true;
            videoPlayer.autoplay = false;
            videoPlayer.preload = "auto";

            // Set up event listeners
            const eventListeners = {
                loadstart: () => {
                    console.log('Video loading started');
                    placeholder.style.display = 'block';
                    videoPlayer.style.display = 'none';
                },
                loadedmetadata: () => {
                    console.log('Video metadata loaded');
                },
                canplay: () => {
                    console.log('Video can start playing');
                    placeholder.style.display = 'none';
                    videoPlayer.style.display = 'block';
                },
                playing: () => {
                    console.log('Video is playing');
                    placeholder.style.display = 'none';
                    videoPlayer.style.display = 'block';
                },
                waiting: () => {
                    console.log('Video is buffering');
                    placeholder.style.display = 'block';
                    videoPlayer.style.display = 'none';
                },
                error: (e) => {
                    console.error('Video error:', videoPlayer.error);
                    placeholder.style.display = 'block';
                    videoPlayer.style.display = 'none';
                }
            };

            // Remove any existing listeners first
            Object.keys(eventListeners).forEach(event => {
                videoPlayer.removeEventListener(event, eventListeners[event]);
            });

            // Add new listeners
            Object.entries(eventListeners).forEach(([event, handler]) => {
                videoPlayer.addEventListener(event, handler);
            });

            try {
                // Show loading state
                placeholder.style.display = 'block';
                videoPlayer.style.display = 'none';

                // Set video source with timestamp to prevent caching
                const timestamp = new Date().getTime();
                videoPlayer.src = `/video/blob/${videoId}?t=${timestamp}`;

                // Load the video
                await videoPlayer.load();

                console.log('Video source set:', videoPlayer.src);

            } catch (error) {
                console.error('Error loading video:', error);
                placeholder.style.display = 'block';
                videoPlayer.style.display = 'none';
            }
        }

        async function initializePage() {
            await checkLoginStatus();
            await loadVideoDetails();
            await loadVideoInteractions();
            await recordView();
            await loadVideo();
        }

        async function loadSubscriptionStatus() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const channelId = urlParams.get('user');
                
                if (!channelId) {
                console.log('No channel ID provided');
                document.querySelector('.subscription-info').style.display = 'none';
                return;
                }

                console.log('Fetching subscription status for:', channelId);
                const response = await fetch(`/api/subscription-status/${channelId}`);
                
                if (!response.ok) {
                console.error('Server response:', response.status, response.statusText);
                const text = await response.text();
                console.error('Response body:', text);
                throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Subscription data:', data);

                const subscribeBtn = document.getElementById('subscribeBtn');
                const subscriptionInfo = document.querySelector('.subscription-info');

                const currentUser = await getCurrentUser();
                if (currentUser && currentUser.userName === channelId) {
                subscriptionInfo.style.display = 'none';
                return;
                }

                subscriptionInfo.style.display = 'flex';
                subscribeBtn.textContent = data.isSubscribed ? 'Subscribed' : 'Subscribe';
                subscribeBtn.classList.toggle('subscribed', data.isSubscribed);
                
                document.getElementById('subscriberCount').textContent = 
                    `${data.subscriberCount} ${data.subscriberCount === 1 ? 'subscriber' : 'subscribers'}`;
            } catch (error) {
                console.error('Error loading subscription status:', error);
                document.querySelector('.subscription-info').style.display = 'none';
            }
        }

        function checkVideoPlayback(videoElement) {
            const videoCheck = document.createElement('video');
            const formats = {
                mp4: 'video/mp4',
                webm: 'video/webm',
                ogg: 'video/ogg'
            };
            
            const supported = Object.entries(formats).filter(([format, mime]) => {
                return videoCheck.canPlayType(mime) !== "";
            });
            
            console.log('Supported video formats:', supported);
            return supported.length > 0;
        }

        window.onload = async function() {
            try {
                await checkLoginStatus();
                const urlParams = new URLSearchParams(window.location.search);
                const videoId = getVideoId();
                if (!videoId) {
                    console.error('No video ID found in URL');
                    return;
                }
                await fetchComments(videoId);

                if (videoId) {
                    // Load video details first
                    const videoDetails = await fetchVideoDetails(videoId);
                    if (videoDetails) {
                        document.title = `${videoDetails.video_name} - YouVideo`;
                        document.getElementById('videoName').textContent = videoDetails.video_name;
                        document.getElementById('authorName').textContent = videoDetails.author;
                        document.getElementById('authorName').href = `/profile.html?user=${videoDetails.author}`;
                        document.getElementById('authorProfilePic').src = `/profile-picture/${videoDetails.author}`;
                        
                        if (videoDetails.video_date) {
                            document.getElementById('uploadDate').textContent = 
                                new Date(videoDetails.video_date).toLocaleDateString();
                        } else {
                            document.getElementById('uploadDate').style.display = 'none';
                        }
                    }

                    // Load the video
                    await loadVideo();
                    
                    // Load additional information
                    await loadVideoInteractions();
                    await recordView(); // Ensure this is called
                } else {
                    console.error('Video ID not found in URL');
                }
            } catch (error) {
                console.error('Error during page initialization:', error);
            }
        };
    </script>
</body>
</html>